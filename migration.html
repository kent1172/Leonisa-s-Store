<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQL Migration - Leonisa's Store</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; line-height: 1.6; color: #333; max-width: 900px; margin: 40px auto; padding: 0 20px; background-color: #f4f7f6; }
        .container { background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h1 { color: #4f46e5; border-bottom: 2px solid #e5e7eb; padding-bottom: 10px; }
        pre { background: #1e1e1e; color: #d4d4d4; padding: 20px; border-radius: 6px; overflow-x: auto; font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace; font-size: 14px; position: relative; }
        .copy-btn { position: absolute; top: 10px; right: 10px; background: #4f46e5; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; }
        .copy-btn:hover { background: #4338ca; }
        .instructions { background: #eff6ff; border-left: 4px solid #3b82f6; padding: 15px; margin-bottom: 20px; border-radius: 0 4px 4px 0; }
        code { background: #e5e7eb; padding: 2px 4px; border-radius: 4px; font-family: monospace; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Leonisa's Store Database Setup</h1>
        
        <div class="instructions">
            <strong>How to use this:</strong>
            <ol>
                <li>Go to your <a href="https://supabase.com/dashboard" target="_blank">Supabase Dashboard</a>.</li>
                <li>Select your project and click on the <strong>SQL Editor</strong> tab in the sidebar.</li>
                <li>Click <strong>New Query</strong>.</li>
                <li>Copy the SQL code below and paste it into the editor.</li>
                <li>Click <strong>Run</strong>.</li>
            </ol>
        </div>

        <pre id="sql-block"><button class="copy-btn" onclick="copySql()">Copy Code</button>-- Leonisa's Store - PostgreSQL Migration Script
-- Designed for Supabase / PostgreSQL

-- 1. Create Profiles table (Extends Auth.Users)
CREATE TABLE IF NOT EXISTS public.profiles (
  id UUID REFERENCES auth.users ON DELETE CASCADE PRIMARY KEY,
  username TEXT,
  role TEXT DEFAULT 'CASHIER' CHECK (role IN ('ADMIN', 'CASHIER')),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL
);

-- 2. Create Products table
CREATE TABLE IF NOT EXISTS public.products (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  name TEXT NOT NULL,
  price DECIMAL(10, 2) NOT NULL,
  category TEXT DEFAULT 'General',
  status TEXT DEFAULT 'active' CHECK (status IN ('active', 'inactive')),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL
);

-- Index for fast product searching
CREATE INDEX IF NOT EXISTS idx_products_name ON public.products USING GIN (to_tsvector('english', name));

-- 3. Create Sales table
CREATE TABLE IF NOT EXISTS public.sales (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  total_amount DECIMAL(10, 2) NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()) NOT NULL,
  created_by UUID REFERENCES auth.users(id)
);

-- 4. Create Sale Items table
CREATE TABLE IF NOT EXISTS public.sale_items (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  sale_id BIGINT REFERENCES public.sales(id) ON DELETE CASCADE,
  product_id BIGINT REFERENCES public.products(id),
  quantity INTEGER NOT NULL CHECK (quantity > 0),
  price_at_sale DECIMAL(10, 2) NOT NULL,
  line_total DECIMAL(10, 2) NOT NULL
);

-- Enable Row Level Security (RLS)
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.products ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.sales ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.sale_items ENABLE ROW LEVEL SECURITY;

-- RLS POLICIES

-- Profiles: Users can see their own profile, Admins see all
CREATE POLICY "Profiles are viewable by owner" ON public.profiles FOR SELECT USING (auth.uid() = id);
CREATE POLICY "Admins can view all profiles" ON public.profiles FOR SELECT USING (
  EXISTS (SELECT 1 FROM public.profiles WHERE id = auth.uid() AND role = 'ADMIN')
);

-- Products: Everyone authenticated can view, only Admins can modify
CREATE POLICY "Products are viewable by all authenticated" ON public.products FOR SELECT TO authenticated USING (true);
CREATE POLICY "Admins can insert products" ON public.products FOR INSERT TO authenticated WITH CHECK (
  EXISTS (SELECT 1 FROM public.profiles WHERE id = auth.uid() AND role = 'ADMIN')
);
CREATE POLICY "Admins can update products" ON public.products FOR UPDATE TO authenticated USING (
  EXISTS (SELECT 1 FROM public.profiles WHERE id = auth.uid() AND role = 'ADMIN')
);
CREATE POLICY "Admins can delete products" ON public.products FOR DELETE TO authenticated USING (
  EXISTS (SELECT 1 FROM public.profiles WHERE id = auth.uid() AND role = 'ADMIN')
);

-- Sales & Items: Authenticated users can create and view
CREATE POLICY "Sales are viewable by authenticated users" ON public.sales FOR SELECT TO authenticated USING (true);
CREATE POLICY "Sales can be created by authenticated users" ON public.sales FOR INSERT TO authenticated WITH CHECK (true);

CREATE POLICY "Sale items are viewable by authenticated users" ON public.sale_items FOR SELECT TO authenticated USING (true);
CREATE POLICY "Sale items can be created by authenticated users" ON public.sale_items FOR INSERT TO authenticated WITH CHECK (true);

-- AUTOMATION: Handle new user registration profile creation
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS trigger AS $$
BEGIN
  INSERT INTO public.profiles (id, username, role)
  VALUES (
    new.id, 
    new.email, 
    COALESCE(new.raw_user_meta_data->>'role', 'CASHIER')
  );
  RETURN new;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Trigger to call handle_new_user on signup
DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;
CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE PROCEDURE public.handle_new_user();</pre>
    </div>

    <script>
        function copySql() {
            const pre = document.getElementById('sql-block');
            const text = pre.innerText.replace('Copy Code', '').trim();
            navigator.clipboard.writeText(text).then(() => {
                const btn = document.querySelector('.copy-btn');
                btn.innerText = 'Copied!';
                setTimeout(() => btn.innerText = 'Copy Code', 2000);
            });
        }
    </script>
</body>
</html>